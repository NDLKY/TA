<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>獎金預算模擬器 (雙重倍數版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        /* 移除原生 number input 的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* 震動動畫 */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-12 flex flex-col items-center justify-center">

    <!-- 登入畫面 -->
    <div id="login-screen" class="w-full max-w-md p-8 bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 space-y-8 animate-in fade-in zoom-in duration-300">
        <div class="text-center space-y-4">
            <div class="inline-flex p-4 bg-blue-600 text-white rounded-3xl shadow-lg shadow-blue-200">
                <i data-lucide="lock" size="32"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight">存取受保護數據</h2>
            <p class="text-slate-400 text-sm font-medium">請輸入密碼以進入預算模擬系統</p>
        </div>
        
        <div class="space-y-4">
            <div class="relative group">
                <i data-lucide="key-round" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 transition-colors" size="20"></i>
                <input type="password" id="password-input" placeholder="請輸入 8 位數密碼" 
                    class="w-full pl-12 pr-4 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:bg-white focus:border-blue-600 focus:outline-none transition-all font-bold tracking-[0.2em] placeholder:tracking-normal placeholder:font-normal"
                    onkeydown="if(event.key==='Enter') verifyPassword()">
            </div>
            <p id="error-message" class="hidden text-rose-500 text-[10px] font-black uppercase tracking-widest text-center">密碼錯誤，請重新輸入</p>
            <button onclick="verifyPassword()" id="unlock-btn" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 hover:scale-[1.02] active:scale-[0.98] transition-all shadow-xl shadow-blue-100 tracking-widest flex items-center justify-center gap-2">
                <span>解鎖系統</span>
            </button>
        </div>
    </div>

    <!-- 主程式介面 (預設隱藏) -->
    <div id="app" class="hidden w-full max-w-7xl mx-auto p-4 md:p-8 space-y-6">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-xl text-white shadow-lg">
                    <i data-lucide="calculator" size="28"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">獎金預算模擬器 (雙重倍數版)</h1>
                    <p class="text-slate-500 text-sm flex items-center gap-2">
                        總人數：<span id="header-total-count" class="font-bold text-blue-600">0 人</span> 
                        <span class="text-slate-300">|</span>
                        12月已領取：<span id="header-dec-paid" class="font-bold text-orange-600">0 人</span>
                    </p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="fetchData()" class="flex items-center gap-2 px-6 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl text-sm font-bold transition-all shadow-sm">
                    <i data-lucide="refresh-cw" size="16"></i> 重新整理
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-blue-600 p-8 rounded-3xl text-white shadow-xl shadow-blue-200 relative overflow-hidden">
                <i data-lucide="dollar-sign" class="absolute -right-4 -top-4 w-32 h-32 opacity-10 text-white"></i>
                <p class="text-blue-100 text-xs font-bold mb-2 tracking-[0.2em] uppercase">本次模擬總預算</p>
                <div id="total-budget" class="text-5xl font-black">$0</div>
                <div class="mt-6 flex items-center gap-2 text-xs text-blue-100 font-bold bg-blue-700/50 w-fit px-3 py-1.5 rounded-full">
                    <i data-lucide="check-circle-2" size="14"></i> 已扣除/調整 12 月發放因素
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <p class="text-slate-400 text-xs font-bold mb-4 tracking-[0.2em] uppercase">領取狀態分佈 (篩選後)</p>
                <div class="flex items-center gap-12">
                    <div class="flex-1">
                        <div id="unpaid-count" class="text-4xl font-black text-slate-800 tracking-tight">0</div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">12 月未領</span>
                        </div>
                    </div>
                    <div class="w-px h-16 bg-slate-100"></div>
                    <div class="flex-1">
                        <div id="paid-count" class="text-4xl font-black text-orange-500 tracking-tight">0</div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">12 月已領</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <section class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="settings-2" size="16" class="text-blue-500"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">倍數設定 (Multipliers)</h3>
                    </div>
                    
                    <div class="flex bg-slate-50 p-1 rounded-xl mb-6">
                        <button onclick="setActiveTab('standard')" id="tab-standard" class="flex-1 py-2 text-[10px] font-bold rounded-lg transition-all bg-white text-blue-600 shadow-sm">
                            標準人員
                        </button>
                        <button onclick="setActiveTab('decPaid')" id="tab-decPaid" class="flex-1 py-2 text-[10px] font-bold rounded-lg transition-all text-slate-400">
                            12月已領
                        </button>
                    </div>

                    <div id="multipliers-inputs" class="space-y-4 border-b border-slate-50 pb-6 mb-6">
                        <!-- Inputs generated by JS -->
                    </div>

                    <div class="relative group">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors" size="16"></i>
                        <input oninput="handleSearch(this.value)" type="text" placeholder="搜尋品牌列表..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-transparent rounded-2xl text-sm focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all outline-none placeholder:text-slate-300">
                    </div>
                </section>
            </div>

            <!-- Content Area -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                    
                    <!-- Brand Filter Area -->
                    <div class="p-8 border-b border-slate-50 bg-slate-50/30">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i data-lucide="filter" size="16" class="text-blue-600"></i>
                                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">選擇包含品牌 (Brand Selection)</h3>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="selectAllBrands()" class="text-[10px] font-bold text-blue-600 hover:underline underline-offset-4">全選 (All)</button>
                                <button onclick="deselectAllBrands()" class="text-[10px] font-bold text-slate-400 hover:text-slate-600 transition-colors">取消全選 (None)</button>
                            </div>
                        </div>
                        <div id="brand-filters" class="flex flex-wrap gap-2">
                            <!-- Buttons generated by JS -->
                        </div>
                    </div>

                    <!-- Table Area -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">
                                    <th class="px-8 py-5">品牌 (Column B)</th>
                                    <th class="px-6 py-5 text-center">總人數</th>
                                    <th class="px-6 py-5 text-center">12月已領</th>
                                    <th class="px-6 py-5 text-right tracking-widest text-slate-400 italic font-medium text-xs text-xs">去年總數 (J)</th>
                                    <th class="px-6 py-5 text-right text-blue-600 font-bold tracking-widest">本次預算</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-slate-50">
                                <!-- Table rows generated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-state" class="hidden p-12 text-center text-slate-400 text-sm font-medium">
                        請選擇至少一個品牌進行分析
                    </div>
                </div>
                <div class="flex items-center gap-2 p-4 bg-slate-100/50 rounded-2xl border border-slate-200">
                    <i data-lucide="info" size="16" class="text-slate-400"></i>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-loose">
                        註：表格已按照 Dermes, Reenex... 等指定品牌順序排列。所有計算基於 Column F (Salary) 乘以等級對應的 Multiplier。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRKCGEF3NufqQ60Cw59xZ4hkRniMjhxBfowQJh2w7OSpMt09XG2E6Rca5DYzzq0XxquQwQLkzOLAfCU/pub?output=csv';
        const BRAND_ORDER = [
            "Dermes", "Reenex", "Elyze", "Evvus - Operations", 
            "Operations Support", "Bioderma - Retail", 
            "Bioderma - OTC", "Vigene - Operations"
        ];
        
        // 密碼的 SHA-256 雜湊值 (對應 "35117386")
        const PASSWORD_HASH = "e2d67768407481f33777d195a63901416757b447831f2479e5a31a7428f52285";

        // State
        let state = {
            rawData: [],
            activeTab: 'standard', 
            multipliers: { A: 0.5, B: 0.5, C: 0.3, D: 0, E: 0 },
            decMultipliers: { A: 0.3, B: 0.3, C: 0, D: 0, E: 0 },
            selectedBrands: new Set(),
            allAvailableBrands: [],
            searchTerm: '',
            isAuthenticated: false
        };

        function refreshIcons() {
            lucide.createIcons();
        }

        // 輔助函式：計算 SHA-256 雜湊
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // 密碼驗證邏輯
        async function verifyPassword() {
            const passwordField = document.getElementById('password-input');
            const input = passwordField.value.trim(); // 使用 trim() 移除前後空格
            const errorMsg = document.getElementById('error-message');
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app');
            const body = document.body;
            const btn = document.getElementById('unlock-btn');

            if (!input) return;

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>驗證中...</span>';

            try {
                const inputHash = await sha256(input);

                if (inputHash === PASSWORD_HASH) {
                    state.isAuthenticated = true;
                    loginScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    body.classList.remove('items-center', 'justify-center');
                    fetchData(); 
                } else {
                    errorMsg.classList.remove('hidden');
                    loginScreen.classList.add('animate-shake');
                    setTimeout(() => loginScreen.classList.remove('animate-shake'), 400);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    passwordField.value = '';
                    passwordField.focus();
                }
            } catch (err) {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function parseCSV(csvText) {
            try {
                const lines = csvText.split(/\r?\n/);
                const rows = lines.map(line => {
                    const result = [];
                    let cur = '';
                    let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        let char = line[i];
                        if (char === '"') inQuote = !inQuote;
                        else if (char === ',' && !inQuote) {
                            result.push(cur);
                            cur = '';
                        } else cur += char;
                    }
                    result.push(cur);
                    return result;
                });

                const dataRows = rows.slice(1).filter(row => row.length > 1 && row[0] !== "");

                const parsed = dataRows.map((row, index) => {
                    const cleanNum = (val) => {
                        if (!val) return 0;
                        return parseFloat(String(val).replace(/[$,]/g, '')) || 0;
                    };
                    const grade = (row[7] || '').trim().toUpperCase();
                    const lastYearValue = cleanNum(row[9]);

                    return {
                        id: row[0] || `ID-${index}`,
                        brand: (row[1] || 'Unknown').trim(),
                        salary: cleanNum(row[5]),
                        grade: grade,
                        lastYear: lastYearValue,
                        isDecPaid: lastYearValue > 0 
                    };
                });

                const brands = Array.from(new Set(parsed.map(item => item.brand))).sort((a, b) => {
                    const indexA = BRAND_ORDER.indexOf(a);
                    const indexB = BRAND_ORDER.indexOf(b);
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return a.localeCompare(b);
                });

                state.allAvailableBrands = brands;
                if (state.selectedBrands.size === 0) {
                    state.selectedBrands = new Set(brands);
                }
                return parsed;
            } catch (e) {
                console.error("CSV Parsing Error:", e);
                return [];
            }
        }

        async function fetchData() {
            if (!state.isAuthenticated) return;

            const headerText = document.querySelector('header h1');
            const originalTitle = headerText.textContent;
            headerText.textContent = "數據載入中...";
            
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Network Error');
                const csvText = await response.text();
                state.rawData = parseCSV(csvText);
                render();
            } catch (err) {
                console.error(err);
                const errorContainer = document.createElement('div');
                errorContainer.className = "fixed bottom-8 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold z-[100] animate-bounce text-sm";
                errorContainer.textContent = "數據連線失敗。請檢查網絡或 CSV 連結。";
                document.body.appendChild(errorContainer);
                setTimeout(() => errorContainer.remove(), 5000);
            } finally {
                headerText.textContent = originalTitle;
                updateStats();
            }
        }

        function setActiveTab(tab) {
            state.activeTab = tab;
            document.getElementById('tab-standard').className = `flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${tab === 'standard' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('tab-decPaid').className = `flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${tab === 'decPaid' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-400'}`;
            renderMultipliers();
        }

        function handleMultiplierChange(grade, value) {
            let val = parseFloat(value) || 0;
            if (val > 2) val = 2;
            if (val < 0) val = 0;
            val = Math.round(val * 10) / 10;

            if (state.activeTab === 'standard') state.multipliers[grade] = val;
            else state.decMultipliers[grade] = val;
            render();
        }

        function adjustMultiplier(grade, delta) {
            const currentData = state.activeTab === 'standard' ? state.multipliers : state.decMultipliers;
            const newVal = (currentData[grade] || 0) + delta;
            handleMultiplierChange(grade, newVal);
        }

        function handleSearch(val) {
            state.searchTerm = val.toLowerCase();
            renderTable();
        }

        function toggleBrand(brand) {
            if (state.selectedBrands.has(brand)) state.selectedBrands.delete(brand);
            else state.selectedBrands.add(brand);
            render();
        }

        function selectAllBrands() {
            state.selectedBrands = new Set(state.allAvailableBrands);
            render();
        }

        function deselectAllBrands() {
            state.selectedBrands = new Set();
            render();
        }

        function calculateSummary() {
            const summary = {};
            const filteredData = state.rawData.filter(item => state.selectedBrands.has(item.brand));

            filteredData.forEach(item => {
                if (!summary[item.brand]) {
                    summary[item.brand] = {
                        name: item.brand, headcount: 0, decPaidCount: 0,
                        totalSalary: 0, totalLastYear: 0, currentBudget: 0
                    };
                }

                const mSet = item.isDecPaid ? state.decMultipliers : state.multipliers;
                const multiplier = mSet[item.grade] || 0;
                const budget = item.salary * multiplier;

                summary[item.brand].headcount++;
                if (item.isDecPaid) summary[item.brand].decPaidCount++;
                summary[item.brand].totalSalary += item.salary;
                summary[item.brand].totalLastYear += item.lastYear;
                summary[item.brand].currentBudget += budget;
            });

            return Object.values(summary)
                .filter(b => b.name.toLowerCase().includes(state.searchTerm))
                .sort((a, b) => {
                    const idxA = BRAND_ORDER.indexOf(a.name);
                    const idxB = BRAND_ORDER.indexOf(b.name);
                    if (idxA !== -1 && idxB !== -1) return indexA - indexB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    return a.name.localeCompare(b.name);
                });
        }

        function renderMultipliers() {
            const container = document.getElementById('multipliers-inputs');
            const data = state.activeTab === 'standard' ? state.multipliers : state.decMultipliers;
            const colors = { A: 'bg-rose-500', B: 'bg-orange-500', C: 'bg-amber-500', D: 'bg-blue-500', E: 'bg-slate-400' };
            const accentClass = state.activeTab === 'standard' ? 'text-blue-600' : 'text-orange-600';
            const btnColor = state.activeTab === 'standard' ? 'hover:bg-blue-50 text-blue-600' : 'hover:bg-orange-50 text-orange-600';

            container.innerHTML = ['A', 'B', 'C', 'D', 'E'].map(grade => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center font-black text-white text-xs ${colors[grade]}">${grade}</div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Grade ${grade}</span>
                    </div>
                    
                    <div class="flex items-center bg-slate-50 rounded-xl border border-slate-100 p-0.5">
                        <button onclick="adjustMultiplier('${grade}', -0.1)" class="w-7 h-7 flex items-center justify-center rounded-lg transition-colors ${btnColor}">
                            <i data-lucide="minus" size="14"></i>
                        </button>
                        <input type="number" step="0.1" min="0" max="2" value="${data[grade].toFixed(1)}" 
                            onchange="handleMultiplierChange('${grade}', this.value)"
                            class="w-10 bg-transparent font-bold text-center text-xs focus:outline-none ${accentClass}">
                        <button onclick="adjustMultiplier('${grade}', 0.1)" class="w-7 h-7 flex items-center justify-center rounded-lg transition-colors ${btnColor}">
                            <i data-lucide="plus" size="14"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        }

        function renderBrandFilters() {
            const container = document.getElementById('brand-filters');
            container.innerHTML = state.allAvailableBrands.map(brand => {
                const isSelected = state.selectedBrands.has(brand);
                return `
                    <button onclick="toggleBrand('${brand}')" 
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-bold transition-all border ${isSelected ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}">
                        ${isSelected ? '<i data-lucide="check" style="width:12px; height:12px;"></i>' : ''}
                        ${brand}
                    </button>
                `;
            }).join('');
            refreshIcons();
        }

        function renderTable() {
            const summary = calculateSummary();
            const body = document.getElementById('data-table-body');
            const empty = document.getElementById('empty-state');

            if (summary.length === 0) {
                body.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            body.innerHTML = summary.map(brand => `
                <tr class="group hover:bg-slate-50/50 transition-all text-sm">
                    <td class="px-8 py-6">
                        <div class="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">${brand.name}</div>
                    </td>
                    <td class="px-6 py-6 text-center">
                        <span class="px-2.5 py-1 bg-slate-100 rounded-lg text-[10px] font-bold text-slate-500">${brand.headcount}</span>
                    </td>
                    <td class="px-6 py-6 text-center">
                        <span class="px-2.5 py-1 bg-orange-50 rounded-lg text-[10px] font-bold text-orange-600">
                            ${brand.decPaidCount > 0 ? brand.decPaidCount : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-6 text-right text-slate-300 font-mono italic text-xs">
                        $${brand.totalLastYear.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </td>
                    <td class="px-6 py-6 text-right font-black text-blue-600 font-mono tracking-tight text-base">
                        $${brand.currentBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            const summary = calculateSummary();
            const totals = summary.reduce((acc, curr) => ({
                bonus: acc.bonus + curr.currentBudget,
                count: acc.count + curr.headcount,
                decPaidCount: acc.decPaidCount + curr.decPaidCount
            }), { bonus: 0, count: 0, decPaidCount: 0 });

            // 更新 Header 與看板數據
            document.getElementById('header-total-count').textContent = `${totals.count} 人`;
            document.getElementById('header-dec-paid').textContent = `${totals.decPaidCount} 人`;
            document.getElementById('total-budget').textContent = `$${totals.bonus.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('unpaid-count').textContent = totals.count - totals.decPaidCount;
            document.getElementById('paid-count').textContent = totals.decPaidCount;
        }

        function render() {
            renderMultipliers();
            renderBrandFilters();
            renderTable();
            updateStats();
        }

        window.onload = () => {
            refreshIcons();
            document.getElementById('password-input').focus();
        };

    </script>
</body>
</html>
