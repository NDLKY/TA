<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>獎金預算模擬器 (穩定同步版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-12 flex flex-col items-center justify-center transition-all duration-500">

    <!-- 登入畫面 -->
    <div id="login-screen" class="w-full max-w-md p-8 bg-white rounded-[2.5rem] shadow-2xl border border-slate-100 space-y-8 animate-in fade-in zoom-in duration-300">
        <div class="text-center space-y-4">
            <div class="inline-flex p-4 bg-blue-600 text-white rounded-3xl shadow-lg shadow-blue-200">
                <i data-lucide="lock" size="32"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 tracking-tight">存取受保護數據</h2>
            <p class="text-slate-400 text-sm font-medium tracking-wide">請輸入 8 位數密碼以進入系統</p>
        </div>
        
        <div class="space-y-4">
            <div class="relative group">
                <i data-lucide="key-round" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-600 transition-colors" size="20"></i>
                <input type="password" id="password-input" placeholder="請輸入密碼" 
                    class="w-full pl-12 pr-4 py-4 bg-slate-50 border-2 border-transparent rounded-2xl focus:bg-white focus:border-blue-600 focus:outline-none transition-all font-bold tracking-[0.2em] placeholder:tracking-normal"
                    onkeydown="if(event.key==='Enter') verifyPassword()">
            </div>
            <p id="error-message" class="hidden text-rose-500 text-[10px] font-black uppercase tracking-widest text-center animate-pulse">密碼不正確，請重新輸入</p>
            <button onclick="verifyPassword()" id="unlock-btn" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 hover:scale-[1.02] active:scale-[0.98] transition-all shadow-xl shadow-blue-100 tracking-widest">
                解鎖並載入數據
            </button>
        </div>
    </div>

    <!-- 主程式介面 -->
    <div id="app" class="hidden w-full max-w-7xl mx-auto p-4 md:p-8 space-y-6 opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-xl text-white shadow-lg">
                    <i data-lucide="calculator" size="28"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">獎金預算模擬器 (雙重倍數版)</h1>
                    <p class="text-slate-500 text-sm flex items-center gap-2 font-medium">
                        總人數：<span id="header-total-count" class="font-black text-blue-600">0 人</span> 
                        <span class="text-slate-300">|</span>
                        12月已領取：<span id="header-dec-paid" class="font-black text-orange-600">0 人</span>
                    </p>
                </div>
            </div>
            <button onclick="fetchData()" id="refresh-btn" class="flex items-center gap-2 px-6 py-2 bg-slate-100 hover:bg-slate-200 rounded-xl text-sm font-bold transition-all shadow-sm">
                <i data-lucide="refresh-cw" size="16"></i> 重新整理
            </button>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-blue-600 p-8 rounded-3xl text-white shadow-xl shadow-blue-200 relative overflow-hidden">
                <i data-lucide="dollar-sign" class="absolute -right-4 -top-4 w-32 h-32 opacity-10 text-white"></i>
                <p class="text-blue-100 text-xs font-bold mb-2 tracking-[0.2em] uppercase">本次模擬總預算</p>
                <div id="total-budget" class="text-5xl font-black">$0</div>
                <div class="mt-6 flex items-center gap-2 text-xs text-blue-100 font-bold bg-blue-700/50 w-fit px-3 py-1.5 rounded-full">
                    <i data-lucide="check-circle-2" size="14"></i> 數據已從 Google Sheets 自動同步
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <p class="text-slate-400 text-xs font-bold mb-4 tracking-[0.2em] uppercase">領取狀態分佈 (篩選後)</p>
                <div class="flex items-center gap-12">
                    <div class="flex-1">
                        <div id="unpaid-count" class="text-4xl font-black text-slate-800 tracking-tight">0</div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-nowrap">12 月未領</span>
                        </div>
                    </div>
                    <div class="w-px h-16 bg-slate-100"></div>
                    <div class="flex-1">
                        <div id="paid-count" class="text-4xl font-black text-orange-500 tracking-tight">0</div>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-nowrap">12 月已領</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <section class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="settings-2" size="16" class="text-blue-500"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em]">倍數設定 (Multipliers)</h3>
                    </div>
                    
                    <div class="flex bg-slate-50 p-1 rounded-xl mb-6 border border-slate-100">
                        <button onclick="setActiveTab('standard')" id="tab-standard" class="flex-1 py-2 text-[10px] font-bold rounded-lg transition-all bg-white text-blue-600 shadow-sm border border-slate-100">標準人員</button>
                        <button onclick="setActiveTab('decPaid')" id="tab-decPaid" class="flex-1 py-2 text-[10px] font-bold rounded-lg transition-all text-slate-400">12月已領</button>
                    </div>

                    <div id="multipliers-inputs" class="space-y-4 border-b border-slate-50 pb-6 mb-6"></div>

                    <div class="relative group">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors" size="16"></i>
                        <input oninput="handleSearch(this.value)" type="text" placeholder="搜尋品牌..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-transparent rounded-2xl text-sm focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all outline-none placeholder:text-slate-300 font-medium">
                    </div>
                </section>
            </div>

            <!-- Content Area -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                    <!-- Brand Selection -->
                    <div class="p-8 border-b border-slate-50 bg-slate-50/30">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-2">
                                <i data-lucide="filter" size="16" class="text-blue-600"></i>
                                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">品牌選擇</h3>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="selectAllBrands()" class="text-[10px] font-bold text-blue-600 hover:underline underline-offset-4">全選</button>
                                <button onclick="deselectAllBrands()" class="text-[10px] font-bold text-slate-400 hover:text-slate-600 transition-colors">取消全選</button>
                            </div>
                        </div>
                        <div id="brand-filters" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Table Area -->
                    <div class="overflow-x-auto" id="table-container">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">
                                    <th class="px-8 py-5">品牌名稱 (Column B)</th>
                                    <th class="px-6 py-5 text-center">總人數</th>
                                    <th class="px-6 py-5 text-center">12月已領</th>
                                    <th class="px-6 py-5 text-right text-slate-300 italic font-bold text-xs tracking-wider">去年總數 (J)</th>
                                    <th class="px-6 py-5 text-right text-blue-600 font-black tracking-widest">本次預算</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                    <div id="loading-state" class="hidden p-24 flex flex-col items-center justify-center space-y-4">
                        <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin shadow-inner"></div>
                        <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] italic">正在同步雲端數據...</p>
                    </div>
                    <div id="empty-state" class="hidden p-12 text-center text-slate-400 text-sm font-medium">請選擇至少一個品牌</div>
                </div>
                <div class="p-5 bg-slate-100/50 rounded-2xl border border-slate-200 shadow-inner">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-loose text-center">
                        註：數據自動對接 Google Sheets。計算基於 Column F (Salary) × Multiplier。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 設定
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRKCGEF3NufqQ60Cw59xZ4hkRniMjhxBfowQJh2w7OSpMt09XG2E6Rca5DYzzq0XxquQwQLkzOLAfCU/pub?output=csv';
        const BRAND_ORDER = ["Dermes", "Reenex", "Elyze", "Evvus - Operations", "Operations Support", "Bioderma - Retail", "Bioderma - OTC", "Vigene - Operations"];
        
        // 密碼：35117386
        const __SEC = "MzUxMTczODY="; 

        let state = {
            rawData: [],
            activeTab: 'standard', 
            // 預設倍數
            multipliers: { A: 0.5, B: 0.5, C: 0.3, D: 0, E: 0 },
            decMultipliers: { A: 0.3, B: 0.3, C: 0, D: 0, E: 0 },
            selectedBrands: new Set(),
            allAvailableBrands: [],
            searchTerm: '',
            isAuthenticated: false
        };

        // 直接同步驗證，解決不穩定問題
        function verifyPassword() {
            const inputField = document.getElementById('password-input');
            const input = inputField.value.trim();
            const errorMsg = document.getElementById('error-message');

            if (!input) return;

            // 比對 Base64
            if (window.btoa(input) === __SEC) {
                state.isAuthenticated = true;
                document.getElementById('login-screen').classList.add('hidden');
                const app = document.getElementById('app');
                app.classList.remove('hidden');
                setTimeout(() => app.style.opacity = '1', 50);
                document.body.classList.remove('items-center', 'justify-center');
                fetchData(); 
            } else {
                errorMsg.classList.remove('hidden');
                inputField.parentElement.classList.add('animate-shake');
                setTimeout(() => inputField.parentElement.classList.remove('animate-shake'), 400);
                inputField.value = '';
                inputField.focus();
            }
        }

        function parseCSV(csvText) {
            try {
                const rows = csvText.split(/\r?\n/).map(line => {
                    const res = []; let cur = ''; let q = false;
                    for (let i = 0; i < line.length; i++) {
                        let c = line[i];
                        if (c === '"') q = !q;
                        else if (c === ',' && !q) { res.push(cur); cur = ''; }
                        else cur += c;
                    }
                    res.push(cur); return res;
                });
                const parsed = rows.slice(1).filter(r => r.length > 5 && r[0] !== "").map((r, i) => {
                    const n = v => {
                        const s = String(v || '').replace(/[$,]/g, '').trim();
                        return parseFloat(s) || 0;
                    };
                    return { 
                        id: r[0] || i, 
                        brand: (r[1] || 'Unknown').trim(), 
                        salary: n(r[5]), 
                        grade: (r[7] || '').trim().toUpperCase(), 
                        lastYear: n(r[9]), 
                        isDecPaid: n(r[9]) > 0 
                    };
                });

                const brands = Array.from(new Set(parsed.map(i => i.brand))).sort((a, b) => {
                    const ia = BRAND_ORDER.indexOf(a), ib = BRAND_ORDER.indexOf(b);
                    if (ia !== -1 && ib !== -1) return ia - ib;
                    return ia !== -1 ? -1 : (ib !== -1 ? 1 : a.localeCompare(b));
                });

                state.allAvailableBrands = brands;
                if (state.selectedBrands.size === 0) state.selectedBrands = new Set(brands);
                return parsed;
            } catch (e) { return []; }
        }

        async function fetchData() {
            if (!state.isAuthenticated) return;
            const loading = document.getElementById('loading-state');
            const table = document.getElementById('table-container');
            const btn = document.getElementById('refresh-btn');

            loading.classList.remove('hidden');
            table.classList.add('opacity-30');
            btn.disabled = true;

            try {
                // 自動「食」CSV 連結
                const response = await fetch(CSV_URL + '?t=' + Date.now()); // 防止緩存
                if (!response.ok) throw new Error();
                const text = await response.text();
                state.rawData = parseCSV(text);
                render();
            } catch (err) {
                console.error(err);
                alert("數據讀取失敗，請檢查 Google Sheets 連結權限。");
            } finally {
                loading.classList.add('hidden');
                table.classList.remove('opacity-30');
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        function setActiveTab(tab) {
            state.activeTab = tab;
            document.getElementById('tab-standard').className = `flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${tab === 'standard' ? 'bg-white text-blue-600 shadow-sm border border-slate-100' : 'text-slate-400'}`;
            document.getElementById('tab-decPaid').className = `flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${tab === 'decPaid' ? 'bg-white text-orange-600 shadow-sm border border-slate-100' : 'text-slate-400'}`;
            renderMultipliers();
        }

        function handleMultiplierChange(grade, value) {
            let val = Math.max(0, Math.min(2, Math.round((parseFloat(value) || 0) * 10) / 10));
            if (state.activeTab === 'standard') state.multipliers[grade] = val;
            else state.decMultipliers[grade] = val;
            render();
        }

        function adjustMultiplier(grade, delta) {
            const cur = state.activeTab === 'standard' ? state.multipliers : state.decMultipliers;
            handleMultiplierChange(grade, (cur[grade] || 0) + delta);
        }

        function handleSearch(val) { state.searchTerm = val.toLowerCase(); renderTable(); }
        function toggleBrand(b) { if (state.selectedBrands.has(b)) state.selectedBrands.delete(b); else state.selectedBrands.add(b); render(); }
        function selectAllBrands() { state.selectedBrands = new Set(state.allAvailableBrands); render(); }
        function deselectAllBrands() { state.selectedBrands = new Set(); render(); }

        function renderMultipliers() {
            const container = document.getElementById('multipliers-inputs');
            const data = state.activeTab === 'standard' ? state.multipliers : state.decMultipliers;
            const colors = { A: 'bg-rose-500', B: 'bg-orange-500', C: 'bg-amber-500', D: 'bg-blue-500', E: 'bg-slate-400' };
            const accent = state.activeTab === 'standard' ? 'text-blue-600' : 'text-orange-600';
            const btn = state.activeTab === 'standard' ? 'hover:bg-blue-50 text-blue-600' : 'hover:bg-orange-50 text-orange-600';

            container.innerHTML = ['A', 'B', 'C', 'D', 'E'].map(g => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center font-black text-white text-xs ${colors[g]}">${g}</div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Grade ${g}</span>
                    </div>
                    <div class="flex items-center bg-slate-50 rounded-xl border border-slate-100 p-0.5 shadow-inner">
                        <button onclick="adjustMultiplier('${g}', -0.1)" class="w-7 h-7 flex items-center justify-center rounded-lg transition-colors ${btn}"><i data-lucide="minus" size="14"></i></button>
                        <input type="number" step="0.1" value="${data[g].toFixed(1)}" onchange="handleMultiplierChange('${g}', this.value)" class="w-10 bg-transparent font-bold text-center text-xs focus:outline-none ${accent}">
                        <button onclick="adjustMultiplier('${g}', 0.1)" class="w-7 h-7 flex items-center justify-center rounded-lg transition-colors ${btn}"><i data-lucide="plus" size="14"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderBrandFilters() {
            const container = document.getElementById('brand-filters');
            container.innerHTML = state.allAvailableBrands.map(b => {
                const s = state.selectedBrands.has(b);
                return `<button onclick="toggleBrand('${b}')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-bold transition-all border ${s ? 'bg-blue-600 text-white border-blue-600 shadow-md scale-105' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}">${s ? '<i data-lucide="check" size="12"></i>' : ''}${b}</button>`;
            }).join('');
            lucide.createIcons();
        }

        function renderTable() {
            const data = state.rawData.filter(i => state.selectedBrands.has(i.brand));
            const summary = {};
            data.forEach(i => {
                if (!summary[i.brand]) summary[i.brand] = { name: i.brand, count: 0, paid: 0, ly: 0, budget: 0 };
                const m = (i.isDecPaid ? state.decMultipliers : state.multipliers)[i.grade] || 0;
                summary[i.brand].count++;
                if (i.isDecPaid) summary[i.brand].paid++;
                summary[i.brand].ly += i.lastYear;
                summary[i.brand].budget += i.salary * m;
            });
            const list = Object.values(summary).filter(b => b.name.toLowerCase().includes(state.searchTerm)).sort((a,b) => {
                const ia = BRAND_ORDER.indexOf(a.name), ib = BRAND_ORDER.indexOf(b.name);
                if (ia !== -1 && ib !== -1) return ia - ib;
                return ia !== -1 ? -1 : (ib !== -1 ? 1 : a.name.localeCompare(b.name));
            });
            const body = document.getElementById('data-table-body');
            body.innerHTML = list.map(b => `
                <tr class="group hover:bg-slate-50/50 transition-all text-sm">
                    <td class="px-8 py-6 font-bold text-slate-800">${b.name}</td>
                    <td class="px-6 py-6 text-center"><span class="px-2.5 py-1 bg-slate-100 rounded-lg text-[10px] font-bold text-slate-500">${b.count}</span></td>
                    <td class="px-6 py-6 text-center"><span class="px-2.5 py-1 bg-orange-50 rounded-lg text-[10px] font-bold text-orange-600">${b.paid || '-'}</span></td>
                    <td class="px-6 py-6 text-right text-slate-300 font-mono italic font-bold text-xs">$${b.ly.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td class="px-6 py-6 text-right font-black text-blue-600 font-mono text-base tracking-tighter">$${b.budget.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                </tr>
            `).join('');
            document.getElementById('empty-state').classList.toggle('hidden', list.length > 0);
            updateStats(list);
        }

        function updateStats(list) {
            const t = list.reduce((a, c) => ({ b: a.b + c.budget, c: a.c + c.count, p: a.p + c.paid }), { b:0, c:0, p:0 });
            document.getElementById('header-total-count').textContent = `${t.c} 人`;
            document.getElementById('header-dec-paid').textContent = `${t.p} 人`;
            document.getElementById('total-budget').textContent = `$${t.b.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            document.getElementById('unpaid-count').textContent = t.c - t.p;
            document.getElementById('paid-count').textContent = t.p;
        }

        function render() { renderMultipliers(); renderBrandFilters(); renderTable(); }
        window.onload = () => { lucide.createIcons(); document.getElementById('password-input').focus(); };
    </script>
</body>
</html>
