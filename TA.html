<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>員工推薦進度查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@400;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: radial-gradient(circle at top left, #f0edff, #e9f2ff, #f8fafc);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            color: #0f172a;
            -webkit-tap-highlight-color: transparent;
        }

        /* Cyber Grid 背景效果 */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#6366f11a 1px, transparent 1px);
            background-size: 35px 35px;
            z-index: -1;
            pointer-events: none;
        }

        .cyber-card {
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.12);
            border-radius: 1.25rem;
            transition: all 0.3s ease;
        }

        .header-glow {
            text-shadow: 0 0 15px rgba(99, 102, 241, 0.25);
        }

        /* 數字清晰化處理與中心對齊 */
        .readable-nums {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0;
            font-family: 'Noto Sans TC', sans-serif !important;
        }

        /* iOS Input Fix */
        input, select {
            font-size: 16px !important;
        }

        /* 表格排版基礎設定 */
        th, td {
            white-space: nowrap;
            padding: 1.25rem 1rem !important;
        }

        .text-left { text-align: left !important; }
        .text-center { text-align: center !important; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }

        .font-cyber { font-family: 'Orbitron', sans-serif; }

        .btn-inactive {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .btn-inactive:active { transform: scale(0.96); }

        .summary-accent {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent);
            border-left: 4px solid #6366f1;
        }
    </style>
</head>
<body class="py-6 md:py-12 px-3 md:px-6">

    <div class="max-w-7xl mx-auto text-left">
        <!-- 頂部標題 -->
        <div class="flex flex-col md:flex-row justify-between items-center md:items-start mb-8 md:mb-12 gap-6 text-left">
            <div class="w-full text-left">
                <h1 class="text-3xl md:text-5xl font-black text-slate-900 mb-2 md:mb-4 tracking-tight header-glow">
                    推薦進度查詢 <span class="text-indigo-600 font-cyber text-2xl md:text-3xl uppercase">Dashboard</span>
                </h1>
                <p class="text-slate-800 font-bold text-sm md:text-lg flex items-center bg-white/60 px-4 py-2 rounded-full w-fit shadow-sm border border-white/80">
                    <svg class="w-4 h-4 md:w-5 md:h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="filter: drop-shadow(0 0 2px #6366f1);"><path stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    範圍：2025/12/15 之後記錄 (排除 LSL/Hipo E1)
                </p>
            </div>
            <div class="cyber-card px-6 py-4 border-l-4 md:border-l-8 border-indigo-500 text-indigo-900 font-black text-sm md:text-base shadow-md w-full md:w-auto" id="lastUpdateDisplay">
                試算表狀態：連線中...
            </div>
        </div>

        <!-- 查詢區域 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8 md:mb-12">
            <!-- 01: 手動查詢 -->
            <div class="lg:col-span-1 cyber-card p-6 md:p-8">
                <h3 class="text-indigo-950 font-black mb-5 md:mb-6 flex items-center uppercase tracking-widest text-sm">
                    手動查詢 <span class="ml-auto opacity-20 font-cyber text-lg text-right">01</span>
                </h3>
                <div class="space-y-4 md:space-y-6 text-left">
                    <div>
                        <label for="staffId" class="block text-[10px] md:text-xs font-black text-slate-600 mb-1 md:mb-2 uppercase tracking-widest">Staff ID</label>
                        <input type="text" id="staffId" placeholder="例如: 11852" 
                               class="w-full px-4 py-3 md:py-4 rounded-xl border-2 border-indigo-100 bg-white focus:ring-4 focus:ring-indigo-200 outline-none transition-all text-slate-900 font-bold">
                    </div>
                    <button onclick="manualSearch()" 
                            class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-black rounded-xl transition shadow-lg active:scale-[0.98] uppercase tracking-widest">
                        執行查詢
                    </button>
                </div>
            </div>

            <!-- 02: 快速篩選 -->
            <div class="lg:col-span-2 cyber-card p-6 md:p-8">
                <h3 class="text-violet-950 font-black mb-5 md:mb-6 flex items-center uppercase tracking-widest text-sm text-left">
                    快速篩選 <span class="ml-auto opacity-20 font-cyber text-lg text-right">02</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 text-left">
                    <div>
                        <label class="block text-[10px] md:text-xs font-black text-slate-600 mb-1 md:mb-2 uppercase tracking-widest">Brand</label>
                        <select id="filterBrand" onchange="updateFloorFilter()" class="w-full px-4 py-3 md:py-4 rounded-xl border-2 border-violet-50 bg-white focus:ring-4 outline-none text-slate-900 font-bold appearance-none cursor-pointer">
                            <option value="">請選擇 Brand</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] md:text-xs font-black text-slate-600 mb-1 md:mb-2 uppercase tracking-widest">Floor</label>
                        <select id="filterFloor" onchange="updateNameFilter()" disabled class="w-full px-4 py-3 md:py-4 rounded-xl border-2 border-violet-50 bg-white focus:ring-4 outline-none text-slate-900 font-bold appearance-none cursor-pointer">
                            <option value="">請選擇 Floor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] md:text-xs font-black text-slate-600 mb-1 md:mb-2 uppercase tracking-widest">Name</label>
                        <select id="filterName" onchange="searchByFilter()" disabled class="w-full px-4 py-3 md:py-4 rounded-xl border-2 border-violet-50 bg-white focus:ring-4 outline-none text-slate-900 font-bold appearance-none cursor-pointer">
                            <option value="">請選擇姓名</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 03: 未推薦檢查 -->
            <div class="lg:col-span-1 cyber-card p-6 md:p-8">
                <h3 class="text-rose-950 font-black mb-5 md:mb-6 flex items-center uppercase tracking-widest text-sm text-left">
                    未推薦檢查 <span class="ml-auto opacity-20 font-cyber text-lg text-right">03</span>
                </h3>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="checkInactive(1)" 
                            class="btn-inactive py-3 px-4 bg-white border-2 border-rose-100 hover:border-rose-300 text-rose-800 font-bold rounded-xl text-sm text-left flex items-center justify-between">
                        最近 1 個月無推薦
                        <svg class="w-4 h-4 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <button onclick="checkInactive(2)" 
                            class="btn-inactive py-3 px-4 bg-white border-2 border-rose-100 hover:border-rose-300 text-rose-800 font-bold rounded-xl text-sm text-left flex items-center justify-between">
                        最近 2 個月無推薦
                        <svg class="w-4 h-4 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <p class="text-[10px] text-slate-400 italic px-1 mt-1 text-left">* 排除 LSL/Hipo E1/Jennifer.tokf</p>
                </div>
            </div>
        </div>

        <!-- 數據統計卡片 -->
        <div id="statsArea" class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-8 md:mb-10 hidden">
            <div class="cyber-card p-4 md:p-8 border-l-4 md:border-l-8 border-blue-500 text-center">
                <p class="text-[10px] md:text-sm text-slate-500 font-black uppercase tracking-widest mb-1">總推薦</p>
                <p id="totalCount" class="text-2xl md:text-5xl font-black text-slate-900 readable-nums text-center">0</p>
            </div>
            <div class="cyber-card p-4 md:p-8 border-l-4 md:border-l-8 border-emerald-500 text-center">
                <p class="text-[10px] md:text-sm text-slate-500 font-black uppercase tracking-widest mb-1">已入職</p>
                <p id="joinedCount" class="text-2xl md:text-5xl font-black text-emerald-600 readable-nums text-center">0</p>
            </div>
            <div class="cyber-card p-4 md:p-8 border-l-4 md:border-l-8 border-rose-500 text-center">
                <p class="text-[10px] md:text-sm text-slate-500 font-black uppercase tracking-widest mb-1">Drop</p>
                <p id="withdrawCount" class="text-2xl md:text-5xl font-black text-rose-600 readable-nums text-center">0</p>
            </div>
            <div class="cyber-card p-4 md:p-8 border-l-4 md:border-l-8 border-amber-500 text-center">
                <p class="text-[10px] md:text-sm text-slate-500 font-black uppercase tracking-widest mb-1">處理中</p>
                <p id="pendingCount" class="text-2xl md:text-5xl font-black text-amber-600 readable-nums text-center">0</p>
            </div>
        </div>

        <!-- 動態推薦追蹤資訊列 -->
        <div id="referralTrackingInfo" class="hidden mb-10 px-6 py-4 rounded-2xl summary-accent bg-white/40 text-left">
            <p id="trackingText" class="text-lg md:text-xl font-black text-indigo-900 tracking-tight"></p>
        </div>

        <!-- 推薦明細區塊 -->
        <div id="resultArea" class="hidden space-y-12 mb-16">
            <div id="sectionRJ">
                <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-4 px-2 border-l-8 border-indigo-600 pl-4 tracking-wider uppercase text-left">
                    RJ 推薦明細 <span class="font-cyber text-indigo-500 ml-2">Referral Join</span>
                </h2>
                <div class="cyber-card overflow-hidden">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full border-collapse">
                            <thead class="bg-indigo-50 border-b-2 border-indigo-100 text-indigo-950 font-black">
                                <tr>
                                    <th class="text-left">被介紹人 (N)</th>
                                    <th class="text-center">日期資訊 (B+C+D)</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">On Board Date</th>
                                    <th class="text-center">最終標記</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBodyRJ" class="divide-y divide-slate-200 text-center"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sectionNJ">
                <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-4 px-2 border-l-8 border-violet-600 pl-4 tracking-wider uppercase text-left">
                    NJ 推薦明細 <span class="font-cyber text-violet-500 ml-2">New Joiner</span>
                </h2>
                <div class="cyber-card overflow-hidden">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full border-collapse">
                            <thead class="bg-violet-50 border-b-2 border-violet-100 text-violet-950 font-black">
                                <tr>
                                    <th class="text-left">被介紹人 (N)</th>
                                    <th class="text-center">日期資訊 (B+C+D)</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">On Board Date</th>
                                    <th class="text-center">最終標記</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBodyNJ" class="divide-y divide-slate-200 text-center"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 相關資訊 -->
        <div id="resultAreaSheet2" class="hidden mb-16">
            <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-4 px-2 border-l-8 border-sky-600 pl-4 tracking-wider uppercase text-left">
                相關資訊 <span class="font-cyber text-sky-500 ml-2">REFERENCE INFO</span>
            </h2>
            <div class="cyber-card overflow-hidden text-center">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full border-collapse">
                        <thead class="bg-sky-50 text-sky-950 border-b-2 border-sky-100 font-black uppercase text-sm">
                            <tr>
                                <th class="text-left border-r border-sky-100">Name</th>
                                <th class="text-center border-r border-sky-100 leading-tight">1月+2月<br>Resign No</th>
                                <th class="text-center border-r border-sky-100 leading-tight">Total Offer <br><span class="text-[10px] block opacity-60 font-bold">(已減無返工Offer)</span></th>
                                <th class="text-center border-r border-sky-100 leading-tight">Should<br>on Board</th>
                                <th class="text-center border-r border-sky-100">On board</th>
                                <th class="text-center border-r border-sky-100">Gap</th>
                                <th class="text-center">NJ Offer</th>
                            </tr>
                        </thead>
                        <tbody id="sheet2TableBody" class="divide-y divide-slate-200 text-lg readable-nums font-bold"></tbody>
                    </table>
                </div>
            </div>
            <div class="mt-4 p-4 md:p-6 bg-white/70 rounded-2xl border-2 border-white shadow-inner text-left">
                <p id="dynamicLogicFormula" class="text-base md:text-xl text-slate-900 font-black italic mb-2 readable-nums leading-relaxed text-left"></p>
                <p class="text-[10px] md:text-sm text-slate-500 italic font-bold uppercase tracking-widest text-left">
                    * Formula: Target (2) + Resign No. - Total Offer = Gap (Excluded LSL/Hipo E1)
                </p>
            </div>
        </div>

        <!-- 非活躍名單 -->
        <div id="inactiveResultArea" class="hidden mb-16 text-left space-y-10">
            <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-6 px-2 border-l-8 border-rose-600 pl-4 tracking-wider uppercase text-left">
                非活躍推薦名單 <span id="inactiveTitleSpan" class="font-cyber text-rose-500 ml-2"></span>
            </h2>
            <div id="inactiveBrandContainer" class="space-y-10 text-left"></div>
        </div>

        <!-- 全局統計區 -->
        <div id="brandSummaryArea" class="hidden mb-16 text-left">
            <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-6 px-2 border-l-8 border-emerald-600 pl-4 tracking-wider uppercase text-left">
                Brand Summary <span class="font-cyber text-emerald-500 ml-2">GLOBAL DATA</span>
            </h2>
            <div class="cyber-card overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full border-collapse text-lg">
                        <thead class="bg-emerald-50 text-emerald-950 border-b-2 border-emerald-100 font-black uppercase text-sm">
                            <tr>
                                <th class="text-left px-10">Brand Name</th>
                                <th class="text-center px-10">Total Offer</th>
                                <th class="text-center px-10 leading-tight">Total Should<br>on Board</th>
                                <th class="text-center px-10 text-emerald-900">Total On board</th>
                                <th class="text-center px-10">Total Gap</th>
                                <th class="text-center px-10">NJ Offer</th>
                            </tr>
                        </thead>
                        <tbody id="brandSummaryBody" class="divide-y divide-slate-200 readable-nums font-bold text-center"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="picSummaryArea" class="hidden mb-24 text-left">
            <h2 class="text-xl md:text-2xl font-black text-slate-900 mb-6 px-2 border-l-8 border-blue-600 pl-4 tracking-wider uppercase text-left">
                PIC Summary <span class="font-cyber text-blue-500 ml-2">BY PERSON</span>
            </h2>
            <div class="cyber-card overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full border-collapse">
                        <thead class="bg-blue-50 text-blue-950 border-b-2 border-blue-100 font-black uppercase text-xs md:text-sm">
                            <tr>
                                <th class="text-left border-r border-blue-100">Brand</th>
                                <th class="text-left border-r border-blue-100">PIC</th>
                                <th class="text-center border-r border-blue-100">Total Offer</th>
                                <th class="text-center border-r border-blue-100 leading-tight">1月+2月<br>Resign No</th>
                                <th class="text-center border-r border-blue-100 leading-tight">Total Offer<br><span class="text-[9px] opacity-60 font-bold">(已減無返工Offer)</span></th>
                                <th class="text-center border-r border-blue-100 leading-tight">Should<br>on Board</th>
                                <th class="text-center border-r border-blue-100">On board</th>
                                <th class="text-center border-r border-blue-100">Gap</th>
                                <th class="text-center">NJ Offer</th>
                            </tr>
                        </thead>
                        <tbody id="picSummaryBody" class="divide-y divide-slate-200 readable-nums font-bold text-center"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 狀態顯示 -->
        <div id="loadingStatus" class="text-center py-10 text-indigo-700 font-black flex flex-col items-center justify-center gap-4">
            <svg class="animate-spin h-8 w-8" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="tracking-[0.2em] uppercase font-cyber text-sm">Synchronizing Database...</span>
        </div>

        <div id="noResult" class="hidden text-center py-20 cyber-card mx-2 text-center">
            <p class="text-slate-500 text-xl font-black uppercase font-cyber text-center">NO RECORD FOUND</p>
            <p class="text-slate-500 text-lg mt-4 font-bold text-center">請檢查編號或日期範圍 (2025/12/15+)</p>
        </div>

        <div id="initialPrompt" class="text-center py-32 md:py-48 opacity-20 uppercase font-cyber text-2xl text-center">
            Enter Staff ID to Start_
        </div>
    </div>

    <script>
        const SHEET1_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQI5NkFNnXAqi78qHKhg6CRZ4ZTVwu1Tevpo2PXdQn85pZWh6GeAhK29Ih4U7B9QKzqucIDomXJh94L/pub?gid=0&single=true&output=csv';
        const SHEET2_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQI5NkFNnXAqi78qHKhg6CRZ4ZTVwu1Tevpo2PXdQn85pZWh6GeAhK29Ih4U7B9QKzqucIDomXJh94L/pub?gid=906179987&single=true&output=csv';
        const DATE_LIMIT = new Date('2025-12-15');

        let dataS1 = [], headersS1 = [], dataS2 = [], headersS2 = [];

        async function init() {
            const updateDisplay = document.getElementById('lastUpdateDisplay');
            const cacheBuster = `&t=${Date.now()}`;
            try {
                const r1 = await fetch(SHEET1_BASE_URL + cacheBuster);
                const lastMod = r1.headers.get('Last-Modified');
                updateDisplay.innerText = lastMod ? `最後更新：${new Date(lastMod).toLocaleString('zh-HK', { hour12: false })}` : `同步時間：${new Date().toLocaleString('zh-HK', { hour12: false })}`;
                const t1 = await r1.text();
                const r2 = await fetch(SHEET2_BASE_URL + cacheBuster);
                const t2 = await r2.text();
                Papa.parse(t1, { header: true, complete: res => { dataS1 = res.data; headersS1 = res.meta.fields; } });
                Papa.parse(t2, { header: true, complete: res => { 
                    const rawData = res.data;
                    const posIndex = 3; 
                    const nameIndex = 5; 
                    dataS2 = rawData.filter(row => {
                        const pos = (row[res.meta.fields[posIndex]] || "").trim().toUpperCase();
                        const name = (row[res.meta.fields[nameIndex]] || "").trim().toLowerCase();
                        return pos !== 'HIPO E1' && name !== 'jennifer.tokf';
                    });
                    headersS2 = res.meta.fields; 
                    populateFilters(); 
                    calculateSummaries(); 
                    document.getElementById('loadingStatus').classList.add('hidden');
                } });
            } catch (e) { console.error(e); }
        }

        // --- 匯總計算 ---
        function calculateSummaries() {
            const brands = ['DERMES', 'ELYZE', 'REENEX'];
            const sumBody = document.getElementById('brandSummaryBody');
            const picBody = document.getElementById('picSummaryBody');
            sumBody.innerHTML = ''; picBody.innerHTML = '';
            let grandTotal = { offer: 0, should: 0, onBoard: 0, gap: 0, njOffer: 0 };

            brands.forEach(brand => {
                const brandRecords = dataS2.filter(i => (i[headersS2[0]]||"").toUpperCase() === brand && !(i[headersS2[5]]||"").toUpperCase().includes("TOTAL"));
                let bs = { offer: 0, should: 0, onBoard: 0, gap: 0, njOffer: 0 };
                brandRecords.forEach(i => {
                    bs.offer += parseFloat((i[headersS2[13]]||"0").replace(/,/g,'')) || 0;
                    bs.should += parseFloat((i[headersS2[15]]||"0").replace(/,/g,'')) || 0;
                    bs.onBoard += parseFloat((i[headersS2[14]]||"0").replace(/,/g,'')) || 0;
                    bs.gap += parseFloat((i[headersS2[17]]||"0").replace(/,/g,'')) || 0;
                    bs.njOffer += parseFloat((i[headersS2[21]]||"0").replace(/,/g,'')) || 0;
                });
                grandTotal.offer += bs.offer; grandTotal.should += bs.should; grandTotal.onBoard += bs.onBoard; grandTotal.gap += bs.gap; grandTotal.njOffer += bs.njOffer;
                sumBody.innerHTML += `<tr class="hover:bg-emerald-50/70 transition duration-300"><td class="px-10 py-5 font-black text-slate-900 text-left">${brand}</td><td class="px-10 py-5 text-slate-800 text-center text-center">${bs.offer.toLocaleString()}</td><td class="px-10 py-5 text-slate-800 text-center text-center">${bs.should.toLocaleString()}</td><td class="px-10 py-5 text-emerald-800 font-black text-2xl text-center text-center">${bs.onBoard.toLocaleString()}</td><td class="px-10 py-5 text-center text-center ${bs.gap < 0 ? 'text-rose-700 font-black' : 'text-slate-800'} text-center">${bs.gap.toLocaleString()}</td><td class="px-10 py-5 text-slate-800 text-center text-center">${bs.njOffer.toLocaleString()}</td></tr>`;
                const uniquePICs = [...new Set(brandRecords.map(i => i[headersS2[2]]).filter(v => v))];
                uniquePICs.forEach(picName => {
                    const picRecords = brandRecords.filter(i => i[headersS2[2]] === picName);
                    let ps = { offer: 0, res: 0, should: 0, onBoard: 0, gap: 0, njOffer: 0 };
                    picRecords.forEach(i => {
                        ps.offer += parseFloat((i[headersS2[13]]||"0").replace(/,/g,'')) || 0;
                        ps.res += (parseFloat(i[headersS2[9]])||0) + (parseFloat(i[headersS2[10]])||0);
                        ps.should += parseFloat((i[headersS2[15]]||"0").replace(/,/g,'')) || 0;
                        ps.onBoard += parseFloat((i[headersS2[14]]||"0").replace(/,/g,'')) || 0;
                        ps.gap += parseFloat((i[headersS2[17]]||"0").replace(/,/g,'')) || 0;
                        ps.njOffer += parseFloat((i[headersS2[21]]||"0").replace(/,/g,'')) || 0;
                    });
                    picBody.innerHTML += `<tr class="hover:bg-blue-50/50 transition duration-300"><td class="px-6 py-5 border-r border-blue-50 text-slate-600 text-left text-left text-left">${brand}</td><td class="px-6 py-5 border-r border-blue-50 font-black text-slate-900 text-left text-left text-left">${picName}</td><td class="px-6 py-5 border-r border-blue-50 text-slate-800 text-center text-center">${ps.offer.toLocaleString()}</td><td class="px-6 py-5 border-r border-blue-50 text-rose-700 font-black text-center text-center text-center">${ps.res.toLocaleString()}</td><td class="px-6 py-5 border-r border-blue-50 text-slate-800 text-center text-center text-center">${ps.offer.toLocaleString()}</td><td class="px-6 py-5 border-r border-blue-50 text-slate-800 text-center text-center text-center">${ps.should.toLocaleString()}</td><td class="px-6 py-5 border-r border-blue-50 text-emerald-800 font-black text-lg text-center text-center text-center">${ps.onBoard.toLocaleString()}</td><td class="px-6 py-5 border-r border-blue-50 text-center text-center text-center ${ps.gap < 0 ? 'text-rose-700 font-black' : 'text-slate-900'} text-center">${ps.gap.toLocaleString()}</td><td class="px-6 py-5 text-slate-800 text-center text-center text-center text-center">${ps.njOffer.toLocaleString()}</td></tr>`;
                });
            });
            sumBody.innerHTML += `<tr class="bg-slate-100 font-black border-t-2 border-slate-300"><td class="px-10 py-6 text-indigo-900 text-left text-left">GRAND TOTAL</td><td class="px-10 py-6 text-slate-950 text-center text-center text-center">${grandTotal.offer.toLocaleString()}</td><td class="px-10 py-6 text-slate-950 text-center text-center text-center">${grandTotal.should.toLocaleString()}</td><td class="px-10 py-6 text-emerald-900 text-2xl text-center text-center text-center">${grandTotal.onBoard.toLocaleString()}</td><td class="px-10 py-6 text-center text-center text-center ${grandTotal.gap < 0 ? 'text-rose-800' : ''} text-center">${grandTotal.gap.toLocaleString()}</td><td class="px-10 py-6 text-slate-950 text-center text-center text-center text-center">${grandTotal.njOffer.toLocaleString()}</td></tr>`;
            document.getElementById('brandSummaryArea').classList.remove('hidden'); document.getElementById('picSummaryArea').classList.remove('hidden');
        }

        // --- 無推薦檢查 ---
        function checkInactive(months) {
            document.getElementById('initialPrompt').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('resultAreaSheet2').classList.add('hidden');
            document.getElementById('referralTrackingInfo').classList.add('hidden');
            document.getElementById('statsArea').classList.add('hidden');
            document.getElementById('noResult').classList.add('hidden');

            const now = new Date();
            const cutoffDate = new Date(); cutoffDate.setMonth(now.getMonth() - months);
            const lastActivityMap = new Map();
            dataS1.forEach(i => {
                const sId = (i[headersS1[9]]||"").trim(); if (!sId) return;
                const bD = parseDate(i[headersS1[1]]), cD = parseDate(i[headersS1[2]]), dD = parseDate(i[headersS1[3]]);
                const latest = new Date(Math.max(...[bD, cD, dD].filter(d => d).map(d => d.getTime())));
                if (latest && !isNaN(latest.getTime())) {
                    if (!lastActivityMap.has(sId) || latest > lastActivityMap.get(sId)) lastActivityMap.set(sId, latest);
                }
            });

            const inactiveList = dataS2.filter(i => {
                const sId = (i[headersS2[4]]||"").trim(), pos = (i[headersS2[3]]||"").trim().toUpperCase();
                if (!sId || i[headersS2[5]].toUpperCase().includes("TOTAL") || pos === 'HIPO E1' || pos === 'CM' || pos === 'DM') return false;
                const lastDate = lastActivityMap.get(sId);
                return !lastDate || lastDate < cutoffDate;
            });

            const container = document.getElementById('inactiveBrandContainer');
            container.innerHTML = '';
            ['DERMES', 'ELYZE', 'REENEX'].forEach(brandName => {
                const brandList = inactiveList.filter(i => (i[headersS2[0]]||"").toUpperCase() === brandName);
                if (brandList.length > 0) {
                    container.innerHTML += `
                        <div class="space-y-4">
                            <h3 class="text-lg font-black text-slate-800 flex items-center bg-white/40 px-4 py-2 rounded-xl w-fit border border-white">
                                <span class="w-3 h-3 bg-rose-500 rounded-full mr-3"></span>
                                ${brandName} <span class="ml-3 text-rose-600 font-cyber text-sm">Total: ${brandList.length}</span>
                            </h3>
                            <div class="cyber-card overflow-hidden">
                                <div class="overflow-x-auto custom-scrollbar">
                                    <table class="w-full border-collapse">
                                        <thead class="bg-rose-50/50 border-b-2 border-rose-100 text-rose-950 font-black text-sm">
                                            <tr>
                                                <th class="text-left border-r border-rose-50">PIC</th>
                                                <th class="text-left border-r border-rose-50">姓名 (Name)</th>
                                                <th class="text-left border-r border-rose-50">職位 (Position)</th>
                                                <th class="text-center border-r border-rose-50">最後比名日期</th>
                                                <th class="text-center">距離今日</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100 font-bold text-lg">
                                            ${brandList.map(i => {
                                                const sId = (i[headersS2[4]]||"").trim();
                                                const lastDate = lastActivityMap.get(sId);
                                                const daysDiff = lastDate ? Math.floor((now - lastDate) / (1000 * 60 * 60 * 24)) + " 天前" : "從無記錄";
                                                return `<tr>
                                                    <td class="text-slate-600 text-left border-r border-rose-50 text-left">${i[headersS2[2]]||"-"}</td>
                                                    <td class="text-slate-900 font-black text-left border-r border-rose-50 text-left">${i[headersS2[5]]||"-"}</td>
                                                    <td class="text-slate-600 text-left border-r border-rose-50 text-left italic text-left">${i[headersS2[3]]||"-"}</td>
                                                    <td class="text-slate-700 text-center border-r border-rose-50 text-center">${lastDate ? lastDate.toLocaleDateString('zh-HK') : "-"}</td>
                                                    <td class="text-rose-700 font-black text-center text-center text-center">${daysDiff}</td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>`;
                }
            });
            document.getElementById('inactiveTitleSpan').innerText = months === 1 ? "最近 1 個月無推薦" : "最近 2 個月無推薦";
            document.getElementById('inactiveResultArea').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('inactiveResultArea').offsetTop - 30, behavior: 'smooth' });
        }

        // --- 核心工具 ---
        function populateFilters() {
            const bSel = document.getElementById('filterBrand');
            const uniqueBrands = [...new Set(dataS2.map(i => i[headersS2[0]]).filter(v => v && !v.toUpperCase().includes("TOTAL")))].sort();
            uniqueBrands.forEach(b => bSel.innerHTML += `<option value="${b}">${b}</option>`);
        }
        function updateFloorFilter() {
            const b = document.getElementById('filterBrand').value, fSel = document.getElementById('filterFloor'), nSel = document.getElementById('filterName');
            fSel.innerHTML = '<option value="">請選擇 Floor</option>'; nSel.innerHTML = '<option value="">請選擇姓名</option>'; nSel.disabled = true;
            if (!b) return fSel.disabled = true;
            const floors = [...new Set(dataS2.filter(i => i[headersS2[0]] === b).map(i => i[headersS2[1]]).filter(v => v))].sort();
            floors.forEach(f => fSel.innerHTML += `<option value="${f}">${f}</option>`); fSel.disabled = false;
        }
        function updateNameFilter() {
            const b = document.getElementById('filterBrand').value, f = document.getElementById('filterFloor').value, nSel = document.getElementById('filterName');
            nSel.innerHTML = '<option value="">請選擇姓名</option>';
            if (!f) return nSel.disabled = true;
            dataS2.filter(i => i[headersS2[0]] === b && i[headersS2[1]] === f).forEach(i => nSel.innerHTML += `<option value="${i[headersS2[5]]}">${i[headersS2[5]]}</option>`); nSel.disabled = false;
        }
        function searchByFilter() {
            const n = document.getElementById('filterName').value, b = document.getElementById('filterBrand').value, f = document.getElementById('filterFloor').value;
            if (!n) return;
            const staff = dataS2.find(i => i[headersS2[5]] === n && i[headersS2[0]] === b && i[headersS2[1]] === f);
            if (staff) { document.getElementById('staffId').value = staff[headersS2[4]]; executeSearch(staff[headersS2[4]]); }
        }
        function manualSearch() { const id = document.getElementById('staffId').value.trim(); if (id) executeSearch(id); }
        
        function executeSearch(staffId) {
            document.getElementById('initialPrompt').classList.add('hidden'); 
            document.getElementById('inactiveResultArea').classList.add('hidden');
            const personInS2 = dataS2.find(i => (i[headersS2[4]]||"").trim() === staffId);
            const f1 = dataS1.filter(i => (i[headersS1[9]]||"").trim() === staffId && (parseDate(i[headersS1[1]]) > DATE_LIMIT || parseDate(i[headersS1[2]]) > DATE_LIMIT));
            const f2 = dataS2.filter(i => (i[headersS2[4]]||"").trim() === staffId);
            if (personInS2 || f1.length || f2.length) {
                renderS1(f1); renderS2(f2); renderTrackingInfo(staffId, personInS2);
                document.getElementById('noResult').classList.add('hidden');
            } else { showNone(); }
        }

        function renderTrackingInfo(staffId, personInS2) {
            const now = new Date();
            const matchingRows = dataS1.filter(i => (i[headersS1[9]]||"").trim() === staffId);
            let latestDate = null;
            matchingRows.forEach(i => {
                const bD = parseDate(i[headersS1[1]]), cD = parseDate(i[headersS1[2]]), dD = parseDate(i[headersS1[3]]);
                const currentMax = new Date(Math.max(...[bD, cD, dD].filter(d => d).map(d => d.getTime())));
                if (currentMax && !isNaN(currentMax.getTime())) { if (!latestDate || currentMax > latestDate) latestDate = currentMax; }
            });
            const infoBox = document.getElementById('referralTrackingInfo');
            const trackingText = document.getElementById('trackingText');
            const name = personInS2 ? personInS2[headersS2[5]] : "同事";
            if (latestDate) {
                const daysDiff = Math.floor((now - latestDate) / (1000 * 60 * 60 * 24));
                trackingText.innerHTML = `${name} 最後介紹同事 (<span class="text-rose-600 font-black">${daysDiff} 天前</span>) (${latestDate.toLocaleDateString('zh-HK')})!`;
            } else {
                trackingText.innerHTML = `${name} 最後介紹同事 (從無記錄)!`;
            }
            infoBox.classList.remove('hidden');
        }

        function parseDate(d) {
            if (!d || d === '-' || d.trim() === "") return null;
            const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
            const p = d.split(/[\s/-]+/);
            if (p.length === 3) {
                let day = parseInt(p[0]), mIdx = months.indexOf(p[1].toLowerCase().substring(0, 3)), yr = parseInt(p[2]);
                if (day && mIdx !== -1 && yr) return new Date(yr, mIdx, day);
            }
            const ts = Date.parse(d); return isNaN(ts) ? null : new Date(ts);
        }

        function renderS1(list) {
            const rbRJ = document.getElementById('resultTableBodyRJ'), rbNJ = document.getElementById('resultTableBodyNJ');
            rbRJ.innerHTML = ''; rbNJ.innerHTML = '';
            let c = { total: 0, joined: 0, drop: 0, wait: 0 };
            list.forEach(i => {
                c.total++;
                const name = i[headersS1[13]], rjnj = (i[headersS1[12]]||"").toUpperCase();
                const bV = (i[headersS1[1]]||"").trim(), cV = (i[headersS1[2]]||"").trim(), dV = (i[headersS1[3]]||"").trim();
                const dParts = [bV, cV, dV].filter(v => v && v !== '-');
                const uParts = []; dParts.forEach(p => { if (!uParts.some(ex => ex.includes(p) || p.includes(ex))) uParts.push(p); });
                const cleanD = uParts.join(' ');
                const tV = (i[headersS1[19]]||"").trim(), uV = (i[headersS1[20]]||"").trim(), vV = (i[headersS1[21]]||"").trim();
                const fullObD = [tV, uV, vV].filter(v => v && v !== '-').join(' ') || "-";
                const status = i[headersS1[22]]||"-", z = i[headersS1[25]]||"PENDING";
                if (z.toUpperCase().includes('ONBOARD')) c.joined++; else if (z.toUpperCase().includes('WITHDRAW') || status.toUpperCase().includes('WITHDRAW')) c.drop++; else c.wait++;
                const tr = `<tr><td class="px-4 md:px-8 py-5 md:py-6 font-black text-slate-950 text-base md:text-xl text-left text-left">${name}</td><td class="px-4 md:px-8 py-5 md:py-6 text-slate-800 text-[10px] md:text-sm font-bold bg-slate-50/50 text-center text-center text-center">${cleanD}</td><td class="px-4 md:px-8 py-5 md:py-6 text-slate-800 text-sm md:text-lg text-center text-center text-center text-center">${status}</td><td class="px-4 md:px-8 py-5 md:py-6 text-slate-600 text-sm md:text-base readable-nums text-center text-center text-center text-center text-center">${fullObD}</td><td class="px-4 md:px-8 py-5 md:py-6 text-center text-center text-center text-center text-center"><span class="px-3 md:px-5 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-sm ${getZColumnClass(z)} text-center text-center">${z}</span></td></tr>`;
                if (rjnj.includes('RJ')) rbRJ.innerHTML += tr; else rbNJ.innerHTML += tr;
            });
            if (!rbRJ.innerHTML) rbRJ.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">No Data</td></tr>';
            if (!rbNJ.innerHTML) rbNJ.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">No Data</td></tr>';
            document.getElementById('totalCount').innerText = c.total; document.getElementById('joinedCount').innerText = c.joined; document.getElementById('withdrawCount').innerText = c.drop; document.getElementById('pendingCount').innerText = c.wait;
            document.getElementById('statsArea').classList.remove('hidden'); document.getElementById('resultArea').classList.remove('hidden');
        }

        function renderS2(list) {
            const rb = document.getElementById('sheet2TableBody'), fm = document.getElementById('dynamicLogicFormula');
            rb.innerHTML = '';
            list.forEach(i => {
                const isAS = (i[headersS2[3]]||"").toUpperCase().includes('AS') || (i[headersS2[3]]||"").toUpperCase() === 'S';
                let rVal = isAS ? (parseFloat(i[headersS2[9]])||0) + (parseFloat(i[headersS2[10]])||0) : 0;
                let offer = parseFloat((i[headersS2[13]]||"0").replace(/,/g,'')) || 0, gap = parseFloat((i[headersS2[17]]||"0").replace(/,/g,'')) || 0, njo = parseFloat((i[headersS2[21]]||"0").replace(/,/g,'')) || 0;
                rb.innerHTML += `<tr class="hover:bg-sky-50 transition duration-300 font-bold"><td class="px-4 md:px-8 py-6 md:py-7 text-slate-950 font-black text-base md:text-xl border-r border-sky-50 text-left text-left text-left text-left text-left">${i[headersS2[5]]}</td><td class="px-4 md:px-8 py-6 md:py-7 text-slate-800 border-r border-sky-50 bg-sky-50/50 text-xl md:text-2xl text-center text-center text-center text-center text-center text-center">${isAS ? rVal : '-'}</td><td class="px-4 md:px-8 py-6 md:py-7 text-slate-700 border-r border-sky-50 text-xl md:text-2xl text-center text-center text-center text-center text-center text-center text-center">${offer}</td><td class="px-4 md:px-8 py-6 md:py-7 text-slate-700 border-r border-sky-50 text-xl md:text-2xl text-center text-center text-center text-center text-center text-center text-center">${i[headersS2[15]]}</td><td class="px-4 md:px-8 py-6 md:py-7 text-slate-700 border-r border-sky-50 text-xl md:text-2xl text-center text-center text-center text-center text-center text-center text-center">${i[headersS2[14]]}</td><td class="px-4 md:px-8 py-6 md:py-7 text-xl md:text-3xl font-black text-center border-r border-sky-50 text-center text-center text-center text-center text-center text-center ${gap < 0 ? 'bg-rose-100 text-rose-900 shadow-inner' : ''}">${gap}</td><td class="px-4 md:px-8 py-6 md:py-7 text-slate-700 text-xl md:text-2xl text-center text-center text-center text-center text-center text-center text-center text-center">${njo}</td></tr>`;
                fm.innerHTML = `Formula Trace: 2 + Resign (<span class="text-indigo-700">${rVal}</span>) - Offer (<span class="text-slate-900">${offer}</span>) = Gap (<span class="${gap < 0 ? 'text-rose-700 underline' : ''}">${gap}</span>)`;
            });
            document.getElementById('resultAreaSheet2').classList.remove('hidden');
        }

        function getZColumnClass(val) {
            const v = val.toUpperCase();
            if (v.includes('WITHDRAW') || v.includes('NO SHOW')) return "bg-rose-100 text-rose-800 border-2 border-rose-200";
            if (v.includes('ONBOARD')) return "bg-emerald-100 text-emerald-900 border-2 border-emerald-200";
            return "bg-amber-100 text-amber-800 border-2 border-amber-200";
        }
        function showNone() {
            document.getElementById('statsArea').classList.add('hidden'); document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('resultAreaSheet2').classList.add('hidden'); document.getElementById('inactiveResultArea').classList.add('hidden');
            document.getElementById('referralTrackingInfo').classList.add('hidden'); document.getElementById('noResult').classList.remove('hidden');
        }
        window.onload = init;
    </script>
</body>
</html>
